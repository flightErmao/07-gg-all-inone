# STM32F411CE MCU 内存分布详解

## 概述

本文档基于链接脚本 `link.lds` 详细分析STM32F411CE微控制器的内存分布，包括FLASH和RAM的各个段分配情况。

## 硬件配置

- **MCU型号**: STM32F411CE
- **FLASH容量**: 512KB  
- **SRAM容量**: 128KB
- **架构**: ARM Cortex-M4

## 内存区域定义

### FLASH (ROM) 区域

```text
起始地址: 0x08000000
结束地址: 0x0807FFFF
总容量:   512KB (524,288 字节)
权限:     只读执行 (rx)
```

### SRAM (RAM) 区域

```text
起始地址: 0x20000000
结束地址: 0x2001FFFF
总容量:   128KB (131,072 字节)
权限:     读写 (rw)
```

## FLASH 内存分布

### 1. .text 段

- **位置**: FLASH 起始位置
- **包含内容**:
  - 中断向量表 (`KEEP(*(.isr_vector))`)
  - 程序代码 (`*(.text)`, `*(.text.*)`)
  - 只读数据/常量 (`*(.rodata)`, `*(.rodata*)`)
  - RT-Thread 符号表:
    - Finsh shell 符号表 (`FSymTab`, `VSymTab`)
    - 初始化函数表 (`SORT(.rti_fn*)`)
    - 构造函数表 (`SORT(.init_array.*)`)

**关键符号**:

- `_stext`: 代码段开始地址
- `_etext`: 代码段结束地址

### 2. .ARM.exidx 段

- **位置**: 紧跟在 .text 段之后
- **功能**: ARM 异常处理索引表
- **关键符号**:
  - `__exidx_start`: 异常索引段开始
  - `__exidx_end`: 异常索引段结束
  - `_sidata`: 初始化数据在FLASH中的位置标记

## RAM 内存分布

### 1. .data 段 (已初始化数据)

- **加载方式**: `AT (_sidata)` - 从FLASH的_sidata位置加载
- **包含内容**:
  - 已初始化的全局变量 (`*(.data)`, `*(.data.*)`)
  - 析构函数表 (`SORT(.dtors.*)`)

**关键符号**:

- `_sdata`: 数据段开始地址
- `_edata`: 数据段结束地址

### 2. .stack 段 (系统栈)

- **大小**: 1KB (0x400 字节)
- **对齐**: 4字节对齐
- **用途**: 系统栈空间

**关键符号**:

- `_sstack`: 栈开始地址
- `_estack`: 栈结束地址
- `_system_stack_size`: 栈大小定义 (0x400)

### 3. .bss 段 (未初始化数据)

- **包含内容**:
  - 未初始化的全局变量 (`*(.bss)`, `*(.bss.*)`)
  - 通用符号 (`*(COMMON)`)
  - 初始化相关的BSS段 (`*(.bss.init)`)

**关键符号**:

- `__bss_start`: BSS段整体开始标记
- `_sbss`: BSS段内容开始地址
- `_ebss`: BSS段内容结束地址
- `__bss_end`: BSS段整体结束标记

### 4. 剩余空间 (堆区域)

- **位置**: BSS段之后到RAM结束
- **用途**: 动态内存分配、堆空间
- **标记**: `_end` - 所有段的结束位置

## 内存布局示意图

```text
FLASH 内存 (0x08000000 - 0x0807FFFF, 512KB)
┌─────────────────────────────────────────────┐
│                .text 段                      │
│  ┌─────────────────────────────────────────┐ │
│  │          中断向量表                      │ │
│  ├─────────────────────────────────────────┤ │
│  │          程序代码                        │ │
│  ├─────────────────────────────────────────┤ │
│  │        只读数据/常量                     │ │
│  ├─────────────────────────────────────────┤ │
│  │      RT-Thread 符号表                   │ │
│  └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────┤
│            .ARM.exidx 段                     │
│         (异常处理索引表)                     │
├─────────────────────────────────────────────┤
│              剩余空间                        │
│           (未使用的FLASH)                    │
└─────────────────────────────────────────────┘

RAM 内存 (0x20000000 - 0x2001FFFF, 128KB)
┌─────────────────────────────────────────────┐
│              .data 段                        │
│         (已初始化数据)                       │
├─────────────────────────────────────────────┤
│             .stack 段                        │
│          (系统栈, 1KB)                       │
├─────────────────────────────────────────────┤
│              .bss 段                         │
│        (未初始化数据)                        │
├─────────────────────────────────────────────┤
│             剩余空间                         │
│     (堆空间/动态内存分配)                    │
└─────────────────────────────────────────────┘
```

## 启动过程中的内存操作

### 1. 数据段初始化

启动代码会执行以下操作：

```c
// 将FLASH中的初始化数据复制到RAM
memcpy(_sdata, _sidata, _edata - _sdata);
```

### 2. BSS段清零

启动代码会清零BSS段：

```c
// 清零未初始化数据段
memset(_sbss, 0, _ebss - _sbss);
```

## 关键符号定义表

| 符号名称 | 描述 | 位置 |
|---------|------|------|
| `_stext` | 代码段开始 | FLASH |
| `_etext` | 代码段结束 | FLASH |
| `_sidata` | 初始化数据在FLASH中的位置 | FLASH |
| `_sdata` | 数据段开始 | RAM |
| `_edata` | 数据段结束 | RAM |
| `_sstack` | 栈开始 | RAM |
| `_estack` | 栈结束 | RAM |
| `__bss_start` | BSS段开始标记 | RAM |
| `_sbss` | BSS段内容开始 | RAM |
| `_ebss` | BSS段内容结束 | RAM |
| `__bss_end` | BSS段结束标记 | RAM |
| `_end` | 所有段结束 | RAM |

## 栈段详细分析

根据您选中的链接脚本段落，`.stack` 段的定义如下：

```linkerscript
.stack :
{
    . = ALIGN(4);        // 4字节对齐
    _sstack = .;         // 标记栈开始地址
    . = . + _system_stack_size;  // 分配栈空间 (0x400 = 1KB)
    . = ALIGN(4);        // 再次确保4字节对齐
    _estack = .;         // 标记栈结束地址
} >RAM                   // 分配到RAM区域
```

**栈段特点**：

1. **大小固定**: 1KB (1024字节)
2. **地址对齐**: 严格按4字节对齐
3. **增长方向**: ARM Cortex-M4使用递减栈（从高地址向低地址增长）
4. **位置**: 位于RAM中.data段之后
5. **用途**: 函数调用、局部变量、中断处理等

## 内存优化建议

### FLASH 优化

1. **代码优化**: 使用 `-Os` 编译选项优化代码大小
2. **常量数据**: 使用 `const` 关键字确保只读数据放在FLASH中
3. **字符串优化**: 避免重复字符串，使用字符串池

### RAM 优化

1. **减少全局变量**: 尽量使用局部变量和动态分配
2. **栈大小调整**: 根据实际需求调整 `_system_stack_size`
3. **BSS段监控**: 减少未初始化的大数组定义
4. **堆管理**: 合理使用动态内存分配

### 监控工具

- 使用 `.map` 文件分析实际内存使用情况
- 使用 `size` 命令查看各段大小
- 在代码中添加内存使用统计函数

## 注意事项

1. **栈溢出防护**: 当前栈大小为1KB，需要根据实际调用深度调整
2. **内存对齐**: 所有段都按4字节对齐，符合ARM Cortex-M4要求
3. **中断向量表**: 必须位于FLASH起始位置，启动代码会设置VTOR寄存器
4. **调试段**: 链接脚本包含完整的调试信息段，便于GDB调试

## 相关文件

- 链接脚本: `board/linker_scripts/link.lds`
- 启动文件: 通常为 `startup_stm32f411xe.s`
- 系统配置: `rtconfig.h`

---

*本文档基于 bernard.xiong 2009-10-14 版本的链接脚本分析生成*
