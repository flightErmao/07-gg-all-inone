# Betaflight 滤波信号路径分析文档

## 目录
- [一、整体信号流程](#一整体信号流程)
- [二、陀螺仪滤波链](#二陀螺仪滤波链)
- [三、D-term滤波链](#三d-term滤波链)
- [四、其他重要滤波](#四其他重要滤波)
- [五、滤波器类型说明](#五滤波器类型说明)
- [六、动态滤波原理](#六动态滤波原理)
- [七、完整信号流程图](#七完整信号流程图)
- [八、关键代码文件索引](#八关键代码文件索引)

---

## 一、整体信号流程

Betaflight的信号处理流程可以概括为：

```
遥控器输入 → RC平滑滤波 → PID计算 → 混控输出
                              ↑
                         陀螺仪数据 → 陀螺仪滤波链
```

整个系统采用**多级渐进式滤波**策略，每一级都有特定的目的：
- **陀螺仪滤波**：消除传感器噪声和机体振动
- **D-term滤波**：进一步平滑角加速度信号，避免D项放大噪声
- **RC滤波**：平滑遥控器输入，避免阶跃变化
- **动态滤波**：根据飞行状态自适应调整滤波参数

---

## 二、陀螺仪滤波链

### 2.1 代码位置
- **主实现文件**：`src/main/sensors/gyro_filter_impl.c` (行23-87)
- **初始化文件**：`src/main/sensors/gyro_init.c`

### 2.2 滤波顺序

#### 第1步：原始数据采集
```c
// 从传感器读取原始数据
gyro.gyroADC[axis]
```
- 读取传感器原始ADC值
- 应用零偏校准
- 进行单位缩放（转换为度/秒）

**代码位置**：`src/main/sensors/gyro.c` 第408-445行

---

#### 第2步：降采样处理
```c
// 使用lowpass2滤波器进行降采样
if (gyro.downsampleFilterEnabled) {
    gyroADCf = gyro.sampleSum[axis];
} else {
    // 使用简单平均
    gyroADCf = gyro.sampleSum[axis] / gyro.sampleCount;
}
```

**作用**：
- 将高频陀螺仪采样（如8kHz）降采样到PID循环频率（如4kHz）
- 减少计算负担
- 提供第一层抗混叠保护

**代码位置**：`src/main/sensors/gyro_filter_impl.c` 第32-43行

---

#### 第3步：RPM滤波器（动态陷波）
```c
#ifdef USE_RPM_FILTER
gyroADCf = rpmFilterApply(axis, gyroADCf);
#endif
```

**作用**：
- 基于电机转速的动态陷波滤波
- 精确消除电机和桨叶产生的谐振频率噪声
- 跟踪电机转速变化，实时调整陷波频率

**特点**：
- 需要支持双向DShot的电调
- 从电调反馈获取电机转速
- 可以设置多个谐波（基频、2倍频、3倍频等）

**代码位置**：
- 应用：`src/main/sensors/gyro_filter_impl.c` 第48-50行
- 实现：`src/main/flight/rpm_filter.c`

---

#### 第4步：静态陷波滤波器
```c
gyroADCf = gyro.notchFilter1ApplyFn((filter_t *)&gyro.notchFilter1[axis], gyroADCf);
gyroADCf = gyro.notchFilter2ApplyFn((filter_t *)&gyro.notchFilter2[axis], gyroADCf);
```

**作用**：
- 两级静态陷波滤波器
- 用于消除固定频率的噪声（如框架共振频率）
- 用户可手动配置中心频率和Q值

**使用场景**：
- 已知的固定共振频率
- 补充动态陷波滤波器的不足

**代码位置**：
- 应用：`src/main/sensors/gyro_filter_impl.c` 第56-57行
- 初始化：`src/main/sensors/gyro_init.c`

---

#### 第5步：陀螺仪低通滤波器（Gyro LPF1）
```c
gyroADCf = gyro.lowpassFilterApplyFn((filter_t *)&gyro.lowpassFilter[axis], gyroADCf);
```

**作用**：
- 第一级低通滤波
- 衰减高频噪声
- 最常用的陀螺仪滤波器

**支持的滤波器类型**：
- PT1（一阶）
- PT2（二阶）
- PT3（三阶）
- Biquad（双二阶）

**典型配置**：
- 截止频率：100-250Hz
- 类型：PT1或PT2

**代码位置**：
- 应用：`src/main/sensors/gyro_filter_impl.c` 第58行
- 初始化：`src/main/sensors/gyro_init.c`

---

#### 第6步：动态陷波滤波器（Dynamic Notch）
```c
#ifdef USE_DYN_NOTCH_FILTER
if (isDynNotchActive()) {
    dynNotchPush(axis, gyroADCf);
    gyroADCf = dynNotchFilter(axis, gyroADCf);
}
#endif
```

**作用**：
- 使用FFT（SDFT）实时分析频谱
- 自动检测和跟踪振动峰值频率
- 动态调整陷波滤波器中心频率

**工作原理**：
1. 实时收集陀螺仪数据
2. 使用滑动DFT（SDFT）进行频谱分析
3. 检测频谱中的峰值
4. 更新陷波滤波器跟踪这些峰值
5. 应用滤波消除振动

**优势**：
- 无需手动调整
- 自适应不同飞行状态
- 精确消除振动而不影响正常控制信号

**代码位置**：
- 应用：`src/main/sensors/gyro_filter_impl.c` 第63-78行
- 实现：`src/main/flight/dyn_notch_filter.c`

---

#### 第7步：最终输出
```c
gyro.gyroADCf[axis] = gyroADCf;
```

**输出**：经过完整滤波链后的陀螺仪数据，供PID控制器使用

**代码位置**：`src/main/sensors/gyro_filter_impl.c` 第84行

---

### 2.3 陀螺仪滤波链总结

```
原始ADC数据 (gyro.gyroADC)
    ↓
降采样滤波 (平均或lowpass2)
    ↓
RPM滤波器 (基于电机转速的动态陷波)
    ↓
静态陷波1 (notchFilter1)
    ↓
静态陷波2 (notchFilter2)
    ↓
低通滤波器 (lowpassFilter - Gyro LPF1)
    ↓
动态陷波 (dynNotchFilter - FFT分析)
    ↓
最终输出 (gyro.gyroADCf)
```

---

## 三、D-term滤波链

### 3.1 为什么需要D-term滤波？

D-term（微分项）对陀螺仪数据进行微分运算以获得角加速度，这会**放大高频噪声**。因此，即使陀螺仪数据已经过滤波，D-term仍需要额外的滤波处理。

### 3.2 代码位置
- **主实现**：`src/main/flight/pid.c` 第1183-1198行
- **滤波器初始化**：`src/main/flight/pid_init.c` 第131-251行

### 3.3 D-term滤波顺序

#### 第1步：输入源
```c
float gyroRateDterm[XYZ_AXIS_COUNT];
gyroRateDterm[axis] = gyro.gyroADCf[axis];
```

**输入**：使用经过完整陀螺仪滤波链的数据（`gyro.gyroADCf`）

**代码位置**：`src/main/flight/pid.c` 第1184-1186行

---

#### 第2步：D-term陷波滤波器
```c
gyroRateDterm[axis] = pidRuntime.dtermNotchApplyFn(
    (filter_t *)&pidRuntime.dtermNotch[axis], gyroRateDterm[axis]);
```

**作用**：
- D-term专用陷波滤波器
- 消除特定频率的振动（通常在80-120Hz范围）
- 独立于陀螺仪滤波器配置

**典型配置**：
- 中心频率：0-200Hz（0表示禁用）
- 截止频率：通常为中心频率的1.5-2倍

**代码位置**：
- 应用：`src/main/flight/pid.c` 第1195行
- 初始化：`src/main/flight/pid_init.c` 第146-165行

---

#### 第3步：D-term低通滤波器1（LPF1）
```c
gyroRateDterm[axis] = pidRuntime.dtermLowpassApplyFn(
    (filter_t *)&pidRuntime.dtermLowpass[axis], gyroRateDterm[axis]);
```

**作用**：
- 第一级D-term低通滤波
- 最重要的D-term滤波器
- 支持动态LPF（根据油门动态调整截止频率）

**支持的滤波器类型**：
- PT1（一阶）
- PT2（二阶）
- PT3（三阶）
- Biquad（双二阶）

**动态LPF特性**：
- 低油门时：较低截止频率（更强滤波，减少噪声）
- 高油门时：较高截止频率（减少延迟，提高响应）
- 自动在滤波和延迟之间取得平衡

**典型配置**：
- 静态截止频率：100-150Hz
- 动态范围：80-200Hz
- 类型：PT1或Biquad

**代码位置**：
- 应用：`src/main/flight/pid.c` 第1196行
- 初始化：`src/main/flight/pid_init.c` 第167-216行
- 动态更新：`src/main/flight/pid.c` 第1586-1620行

---

#### 第4步：D-term低通滤波器2（LPF2）
```c
gyroRateDterm[axis] = pidRuntime.dtermLowpass2ApplyFn(
    (filter_t *)&pidRuntime.dtermLowpass2[axis], gyroRateDterm[axis]);
```

**作用**：
- 第二级D-term低通滤波
- 提供额外的噪声衰减
- 通常使用较高截止频率以减少累积延迟

**典型配置**：
- 截止频率：150-250Hz
- 类型：PT1或PT2
- 可以设置为0禁用

**代码位置**：
- 应用：`src/main/flight/pid.c` 第1197行
- 初始化：`src/main/flight/pid_init.c` 第218-251行

---

#### 第5步：计算微分（Delta）
```c
// 计算陀螺仪角速度的变化率（角加速度）
const float delta = -(gyroRateDterm[axis] - previousGyroRateDterm[axis]) * pidRuntime.pidFrequency;

// 应用Kd增益
float preTpaD = pidRuntime.pidCoefficient[axis].Kd * delta;
```

**计算说明**：
- `delta`：角加速度（单位：度/秒²）
- 负号：因为D-term需要阻尼效应
- `pidFrequency`：PID循环频率（用于正确的时间微分）

**代码位置**：`src/main/flight/pid.c` 第1408-1409行

---

#### 第6步：D-Max动态增益调整（可选）
```c
#ifdef USE_D_MAX
float dMaxMultiplier = 1.0f;
if (pidRuntime.dMaxPercent[axis] > 1.0f) {
    // 基于陀螺仪变化率的增益
    float dMaxGyroFactor = pt2FilterApply(&pidRuntime.dMaxRange[axis], delta);
    dMaxGyroFactor = fabsf(dMaxGyroFactor) * pidRuntime.dMaxGyroGain;
    
    // 基于设定点变化率的增益
    const float dMaxSetpointFactor = fabsf(pidSetpointDelta) * pidRuntime.dMaxSetpointGain;
    
    // 取两者最大值
    const float dMaxBoost = fmaxf(dMaxGyroFactor, dMaxSetpointFactor);
    
    // 计算最终倍数
    dMaxMultiplier += (pidRuntime.dMaxPercent[axis] - 1.0f) * dMaxBoost;
    dMaxMultiplier = pt2FilterApply(&pidRuntime.dMaxLowpass[axis], dMaxMultiplier);
    dMaxMultiplier = MIN(dMaxMultiplier, pidRuntime.dMaxPercent[axis]);
}

// 应用增益
preTpaD *= dMaxMultiplier;
#endif
```

**作用**：
- 在需要时动态增加D-term增益
- 检测快速的机动或扰动
- 暂时增加D-term以提供更强的阻尼

**使用场景**：
- 快速拉杆时增加阻尼
- 遇到扰动（如穿越门）时增强稳定性
- 在涡旋区（propwash）增加控制能力

**关键参数**：
- `D_MAX_RANGE_HZ = 85Hz`：检测涡旋频率范围的PT2滤波器
- `D_MAX_LOWPASS_HZ = 35Hz`：平滑增益变化的PT2滤波器

**代码位置**：`src/main/flight/pid.c` 第1417-1438行

---

#### 第7步：TPA（油门衰减）
```c
pidData[axis].D = preTpaD * getTpaFactor(pidProfile, axis, TERM_D);
```

**作用**：
- 根据油门位置降低D-term
- 避免高油门时过度反应
- 减少高速飞行时的振荡

**原理**：
- 高油门时，电机响应更快，不需要太强的D-term
- TPA因子在0-1之间，油门越高，因子越小

**代码位置**：`src/main/flight/pid.c` 第1441行

---

### 3.4 D-term滤波链总结

```
陀螺仪滤波数据 (gyro.gyroADCf)
    ↓
D-term陷波滤波器 (dtermNotch)
    ↓
D-term低通滤波器1 (dtermLowpass - 支持动态LPF)
    ↓
D-term低通滤波器2 (dtermLowpass2)
    ↓
计算微分 delta = -(current - previous) × pidFrequency
    ↓
应用Kd增益 preTpaD = Kd × delta
    ↓
D-Max动态增益 (可选，在需要时增强D-term)
    ↓
TPA油门衰减 D = preTpaD × tpaFactor
    ↓
最终D-term输出 (pidData[axis].D)
```

---

## 四、其他重要滤波

### 4.1 RC平滑滤波（RC Smoothing）

#### 作用
- 在PID输入之前对遥控器信号进行平滑
- 消除遥控器数据包的阶跃变化
- 减少对P-term和D-term的冲击

#### 实现
```c
// 对摇杆设定点进行PT3滤波
*dst = pt3FilterApply(&rcSmoothingData.filterSetpoint[i], rxDataToSmooth[i]);

// 对前馈信号进行PT3滤波
feedforwardSmoothed[axis] = pt3FilterApply(
    &rcSmoothingData.filterFeedforward[axis], feedforwardRaw[axis]);
```

#### 特点
- 使用PT3滤波器（三阶低通）
- 自动模式：根据接收机刷新率自动调整截止频率
- 手动模式：用户可指定截止频率
- 分离的油门和姿态通道滤波

#### 自动截止频率计算
```c
smoothingData->setpointCutoffFrequency = 
    MAX(minCutoffHz, smoothedRxRateHz * smoothingData->autoSmoothnessFactorSetpoint);
```

**公式**：
- 接收机刷新率高 → 截止频率高 → 延迟低
- 接收机刷新率低 → 截止频率低 → 更强平滑

#### 代码位置
- 主实现：`src/main/fc/rc.c` 第395-425行
- 配置更新：`src/main/fc/rc.c` 第343-380行

---

### 4.2 Feedforward滤波

#### 作用
- 平滑前馈信号
- 减少前馈对电机输出的突变
- 提供更平滑的飞行感受

#### 实现
```c
// PT1滤波器用于前馈速度和加速度
float pt1K = pt1FilterGainFromDelay(pid->feedforwardSmoothFactor, 1.0f / smoothedRxRateHz);
pt1FilterUpdateCutoff(&feedforwardData.filterSetpointSpeed[axis], pt1K);
pt1FilterUpdateCutoff(&feedforwardData.filterSetpointDelta[axis], pt1K);
```

#### 特点
- 使用PT1滤波器
- 基于延迟时间（而非截止频率）配置
- 根据接收机刷新率自适应调整

#### 代码位置
- `src/main/fc/rc.c` 第383-392行

---

### 4.3 IMU陀螺仪滤波

#### 作用
- 专用于姿态解算（IMU）的额外低频滤波
- 提供稳定的姿态估计
- 不影响PID控制循环

#### 实现
```c
gyroFilteredDownsampled[axis] = pt1FilterApply(&gyro.imuGyroFilter[axis], gyro.gyroADCf[axis]);
```

#### 特点
- 使用PT1滤波器
- 截止频率通常为50Hz（`ATTITUDE_CUTOFF_HZ`）
- 与PID陀螺仪数据分离

#### 代码位置
- `src/main/sensors/gyro.c` 第513行
- `src/main/flight/pid_init.c` 第59行

---

### 4.4 P-term Yaw低通滤波

#### 作用
- 专门用于Yaw轴P-term的额外低通滤波
- 减少Yaw轴的高频振荡
- 可选功能，默认禁用

#### 实现
```c
pidData[axis].P = pidRuntime.ptermYawLowpassApplyFn(
    (filter_t *)&pidRuntime.ptermYawLowpass, pidData[axis].P);
```

#### 代码位置
- `src/main/flight/pid_init.c` 第252-271行

---

## 五、滤波器类型说明

### 5.1 PT1滤波器（一阶低通）

#### 数学公式
```
y[n] = y[n-1] + k × (x[n] - y[n-1])
```
其中：`k = dT / (dT + 1/(2πfc))`

#### 特点
- **最简单**的低通滤波器
- **延迟最小**（约 1/(2πfc) 秒）
- 每倍频衰减20dB
- 相位滞后：-45°（在截止频率处）

#### 频率响应
- -3dB点：截止频率fc
- 滚降斜率：-20dB/decade（-6dB/octave）

#### 适用场景
- 需要最小延迟的场合
- 噪声不是很严重时
- RC平滑滤波

#### 代码实现
```c
FAST_CODE float pt1FilterApply(pt1Filter_t *filter, float input)
{
    filter->state = filter->state + filter->k * (input - filter->state);
    return filter->state;
}
```

**代码位置**：`src/main/common/filter.c` 第76-80行

---

### 5.2 PT2滤波器（二阶低通）

#### 数学公式
```
y1[n] = y1[n-1] + k × (x[n] - y1[n-1])
y[n] = y[n-1] + k × (y1[n] - y[n-1])
```

#### 特点
- 两个PT1滤波器串联
- 每倍频衰减40dB
- 延迟约为PT1的2倍
- 相位滞后：-90°（在截止频率处）

#### 频率响应
- -3dB点：约为设定频率的0.8倍（需校正系数）
- 滚降斜率：-40dB/decade（-12dB/octave）
- 过渡带更陡峭

#### 适用场景
- 需要较强滤波效果
- 可接受适度延迟
- D-term LPF2常用选择

#### 校正系数
```c
#define CUTOFF_CORRECTION_PT2 0.694f
float pt2FilterGain(float f_cut, float dT) {
    return pt1FilterGain(f_cut * CUTOFF_CORRECTION_PT2, dT);
}
```

#### 代码实现
```c
FAST_CODE float pt2FilterApply(pt2Filter_t *filter, float input)
{
    filter->state1 = filter->state1 + filter->k * (input - filter->state1);
    filter->state = filter->state + filter->k * (filter->state1 - filter->state);
    return filter->state;
}
```

**代码位置**：`src/main/common/filter.c` 第114-119行

---

### 5.3 PT3滤波器（三阶低通）

#### 数学公式
```
y1[n] = y1[n-1] + k × (x[n] - y1[n-1])
y2[n] = y2[n-1] + k × (y1[n] - y2[n-1])
y[n] = y[n-1] + k × (y2[n] - y[n-1])
```

#### 特点
- 三个PT1滤波器串联
- 每倍频衰减60dB
- 延迟约为PT1的3倍
- **最强的滤波效果**
- 相位滞后：-135°（在截止频率处）

#### 频率响应
- -3dB点：约为设定频率的0.72倍（需校正系数）
- 滚降斜率：-60dB/decade（-18dB/octave）
- 过渡带非常陡峭

#### 适用场景
- RC平滑滤波（标准选择）
- Feedforward滤波
- 需要强力平滑的场合

#### 校正系数
```c
#define CUTOFF_CORRECTION_PT3 0.716f
```

#### 代码位置
- `src/main/common/filter.c` 第141-159行

---

### 5.4 Biquad滤波器（双二阶IIR）

#### 传递函数
```
H(z) = (b0 + b1×z⁻¹ + b2×z⁻²) / (1 + a1×z⁻¹ + a2×z⁻²)
```

#### 特点
- 标准的二阶IIR滤波器
- 可实现多种滤波器类型：
  - 低通（LPF）
  - 高通（HPF）
  - 带通（BPF）
  - 陷波（Notch）
- 每倍频衰减40dB（低通模式）
- 陡峭的过渡带

#### 直接I型实现（DF1）
```c
FAST_CODE float biquadFilterApplyDF1(biquadFilter_t *filter, float input)
{
    const float result = filter->b0 * input + filter->b1 * filter->x1 + filter->b2 * filter->x2 
                       - filter->a1 * filter->y1 - filter->a2 * filter->y2;
    filter->x2 = filter->x1;
    filter->x1 = input;
    filter->y2 = filter->y1;
    filter->y1 = result;
    return result;
}
```

#### 直接II型实现（DF2）
```c
FAST_CODE float biquadFilterApply(biquadFilter_t *filter, float input)
{
    const float result = filter->b0 * input + filter->x1;
    filter->x1 = filter->b1 * input - filter->a1 * result + filter->x2;
    filter->x2 = filter->b2 * input - filter->a2 * result;
    return result;
}
```

#### DF1 vs DF2
- **DF1**：适用于动态更新系数（如动态LPF）
- **DF2**：计算效率更高，但系数变化时会产生瞬态

#### 陷波滤波器配置
```c
// Q值决定陷波宽度
// Q越高 → 陷波越窄 → 只影响中心频率附近
// Q越低 → 陷波越宽 → 影响更宽的频率范围
biquadFilterInit(&filter, centerHz, looptimeUs, Q, FILTER_NOTCH, 1.0f);
```

#### 适用场景
- 陀螺仪和D-term的低通滤波
- 陷波滤波器（静态和动态）
- 需要陡峭滚降的场合

#### 代码位置
- `src/main/common/filter.c` 第164-274行

---

### 5.5 陷波滤波器（Notch Filter）

#### 原理
- 基于Biquad实现
- 在特定中心频率产生深度衰减
- 对其他频率影响很小

#### 参数
- **中心频率（fc）**：需要消除的频率
- **Q值**：陷波的锐度
  - Q = 1-2：宽陷波（影响较宽频率范围）
  - Q = 3-10：窄陷波（精确消除特定频率）
  - 推荐值：Q = 2.5-4

#### 频率响应
```
增益(f) = 
  - fc处：-40dB到-60dB（深度衰减）
  - fc±20%：-3dB到-10dB
  - fc±50%：接近0dB（几乎不衰减）
```

#### 使用场景
- 静态陷波：消除已知的固定共振频率
- 动态陷波：跟踪和消除变化的振动频率
- RPM滤波器：消除与电机转速相关的噪声

#### 代码位置
- 初始化：`src/main/common/filter.c` 第319-353行

---

### 5.6 滤波器性能对比表

| 滤波器类型 | 滚降速度 | 延迟 | 计算成本 | 适用场景 |
|-----------|---------|------|---------|---------|
| **PT1** | -20dB/dec | 最小 | 最低 | RC平滑、IMU滤波 |
| **PT2** | -40dB/dec | 中等 | 低 | D-term LPF2 |
| **PT3** | -60dB/dec | 较大 | 中等 | RC平滑、Feedforward |
| **Biquad** | -40dB/dec | 中等 | 中等 | 陀螺仪LPF、D-term LPF1 |
| **Notch** | 特定频率 | 很小 | 中等 | 消除共振频率 |

---

## 六、动态滤波原理

### 6.1 动态陷波滤波器（Dynamic Notch Filter）

#### 6.1.1 概述
动态陷波滤波器是Betaflight中最先进的噪声消除技术，能够**自动检测和跟踪**飞行中产生的振动频率，并实时调整陷波滤波器来消除这些振动。

#### 6.1.2 工作原理

```
陀螺仪数据流
    ↓
【数据收集】累积和降采样
    ↓
【频谱分析】SDFT（滑动离散傅里叶变换）
    ↓
【峰值检测】找出最强的振动频率
    ↓
【频率估计】精确计算峰值中心频率
    ↓
【滤波器更新】调整陷波滤波器参数
    ↓
【应用滤波】消除检测到的振动
```

#### 6.1.3 详细实现步骤

##### 步骤1：数据收集和降采样
```c
// 累积样本
sampleAccumulator[axis] += gyroData;
sampleIndex++;

// 当累积足够样本后计算平均值
if (sampleIndex == sampleCount) {
    sampleAvg[axis] = sampleAccumulator[axis] * sampleCountRcp;
    sampleAccumulator[axis] = 0;
    sampleIndex = 0;
}
```

**目的**：
- 降低SDFT的采样率（通常降至1333Hz左右）
- 减少计算负担
- 提供抗混叠保护

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第219-235行

---

##### 步骤2：SDFT频谱分析
```c
// 批量更新SDFT
for (int axis = 0; axis < XYZ_AXIS_COUNT; axis++) {
    sdftPushBatch(&sdft[axis], sampleAvg[axis], sampleIndex);
}
```

**SDFT特点**：
- **滑动DFT**：不需要等待完整的数据窗口
- **实时更新**：每个新样本到达就更新频谱
- **计算效率**：比FFT更适合实时系统
- **频率分辨率**：sdftSampleRateHz / SDFT_BIN_COUNT
  - 例如：1333Hz / 72 = 18.5Hz per bin

**频率范围**：
- 可用带宽：0 到 sdftSampleRateHz/2
- 例如：1333Hz采样率 → 0-666Hz可用范围

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第240-242行

---

##### 步骤3：峰值检测
```c
// 在频谱中查找最强的peaks
for (int p = 0; p < dynNotch.count; p++) {
    // 找到最大值的bin
    int maxBin = findPeakBin(sdftData, sdftStartBin, sdftEndBin);
    peaks[p].bin = maxBin;
    peaks[p].value = sdftData[maxBin];
    
    // 将该峰值及周围的bin置零，以便找到下一个峰值
    clearPeakRegion(sdftData, maxBin);
}
```

**多峰值检测**：
- 可以同时跟踪多个振动频率（通常配置为3-5个）
- 每个峰值对应一个陷波滤波器
- 峰值按强度排序

**噪声阈值**：
```c
// 只有超过噪声阈值的峰值才被认为是真实振动
if (peaks[p].value > sdftNoiseThreshold) {
    // 这是有效峰值
}
```

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第253-336行

---

##### 步骤4：精确频率估计
```c
// 使用抛物线插值精确估计峰值频率
const float y0 = sdftData[peaks[p].bin - 1];  // 左肩
const float y1 = sdftData[peaks[p].bin];      // 峰值
const float y2 = sdftData[peaks[p].bin + 1];  // 右肩

// 拟合抛物线并求极值点
float meanBin = peaks[p].bin;
const float denom = 2.0f * (y0 - 2*y1 + y2);
if (denom != 0.0f) {
    meanBin += (y0 - y2) / denom;  // 亚bin精度
}

// 转换为频率
const float centerFreq = meanBin * sdftResolutionHz;
```

**抛物线插值原理**：
- FFT bin只能提供离散的频率点
- 真实峰值可能在两个bin之间
- 使用三点拟合抛物线可以获得亚bin精度
- 显著提高频率估计精度

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第345-359行

---

##### 步骤5：频率平滑跟踪
```c
// PT1平滑，快速接近强峰值，缓慢远离
const float cutoffMult = constrainf(peaks[p].value / sdftNoiseThreshold, 1.0f, 10.0f);
const float gain = pt1FilterGain(DYN_NOTCH_SMOOTH_HZ * cutoffMult, pt1LooptimeS);

// 更新中心频率
dynNotch.centerFreq[state.axis][p] += gain * (centerFreq - dynNotch.centerFreq[state.axis][p]);
```

**自适应平滑**：
- **强峰值**：快速跟踪（cutoffMult最大10倍）
- **弱峰值**：缓慢跟踪（cutoffMult接近1倍）
- **避免抖动**：防止陷波频率快速波动

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第361-366行

---

##### 步骤6：更新Biquad滤波器
```c
// 只有当峰值有效时才更新滤波器系数
if (peaks[p].bin != 0 && peaks[p].value > sdftNoiseThreshold) {
    biquadFilterUpdate(&dynNotch.notch[state.axis][p], 
                      dynNotch.centerFreq[state.axis][p], 
                      dynNotch.looptimeUs, 
                      dynNotch.q, 
                      FILTER_NOTCH, 
                      1.0f);
}
```

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第390-395行

---

##### 步骤7：应用滤波
```c
FAST_CODE float dynNotchFilter(const int axis, float value)
{
    // 串联所有陷波滤波器
    for (int p = 0; p < dynNotch.count; p++) {
        value = biquadFilterApplyDF1(&dynNotch.notch[axis][p], value);
    }
    return value;
}
```

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第406-413行

---

#### 6.1.4 状态机设计

动态陷波使用**分时多任务**状态机，避免CPU负担过重：

```c
typedef enum {
    STEP_WINDOW,           // 应用窗口函数
    STEP_DETECT_PEAKS,     // 检测峰值
    STEP_CALC_FREQUENCIES, // 计算频率
    STEP_UPDATE_FILTERS,   // 更新滤波器
    STEP_COUNT
} step_e;
```

**执行流程**：
```
每个PID循环 → 处理1个轴的1个步骤
总共需要：3轴 × 4步骤 = 12个PID循环完成一次完整更新

在8kHz PID频率下：
- 每轴更新率：8000 / 12 ≈ 666Hz
- 每轴更新间隔：1.5ms
```

**优势**：
- 分散计算负担
- 不会阻塞PID循环
- 保持实时性能

**代码位置**：`src/main/flight/dyn_notch_filter.c` 第91-99行

---

#### 6.1.5 关键参数配置

| 参数 | 典型值 | 说明 |
|-----|-------|------|
| **dyn_notch_count** | 3-5 | 同时跟踪的峰值数量 |
| **dyn_notch_q** | 250-400 (2.5-4.0) | 陷波Q值，越高越窄 |
| **dyn_notch_min_hz** | 100-150 | 最低跟踪频率 |
| **dyn_notch_max_hz** | 600-800 | 最高跟踪频率 |

---

#### 6.1.6 动态陷波的优势

1. **自适应**：自动适应不同飞行状态和机架配置
2. **精确**：使用FFT分析，精确定位振动频率
3. **多频率**：同时处理多个振动源
4. **低延迟**：陷波滤波器对相位影响小
5. **智能跟踪**：强峰值快速跟踪，弱峰值缓慢跟踪

---

#### 6.1.7 动态陷波 vs 静态陷波

| 特性 | 动态陷波 | 静态陷波 |
|-----|---------|---------|
| **配置** | 自动 | 需要手动调整 |
| **适应性** | 跟踪变化的频率 | 只针对固定频率 |
| **CPU使用** | 中等（FFT计算） | 很低 |
| **效果** | 优秀 | 良好（如果配置正确） |
| **使用场景** | 标准配置 | 补充或已知共振点 |

---

### 6.2 动态低通滤波器（Dynamic LPF）

#### 6.2.1 概述
动态LPF根据**油门位置**自动调整D-term低通滤波器的截止频率，在低油门时提供更强的滤波，高油门时减少延迟。

#### 6.2.2 工作原理

```c
void dynLpfDTermUpdate(float throttle)
{
    // 根据油门计算截止频率
    float cutoffFreq;
    if (pidRuntime.dynLpfCurveExpo > 0) {
        // 使用曲线公式
        cutoffFreq = dynLpfCutoffFreq(throttle, 
                                     pidRuntime.dynLpfMin, 
                                     pidRuntime.dynLpfMax, 
                                     pidRuntime.dynLpfCurveExpo);
    } else {
        // 线性映射
        cutoffFreq = fmaxf(dynThrottle(throttle) * pidRuntime.dynLpfMax, 
                          pidRuntime.dynLpfMin);
    }
    
    // 更新滤波器截止频率
    for (int axis = 0; axis < XYZ_AXIS_COUNT; axis++) {
        pt1FilterUpdateCutoff(&pidRuntime.dtermLowpass[axis].pt1Filter, 
                             pt1FilterGain(cutoffFreq, pidRuntime.dT));
    }
}
```

#### 6.2.3 曲线公式
```c
float dynLpfCutoffFreq(float throttle, uint16_t dynLpfMin, uint16_t dynLpfMax, uint8_t expo)
{
    const float expof = expo / 10.0f;
    // 抛物线曲线：在中油门区域变化更平缓
    const float curve = throttle * (1 - throttle) * expof + throttle;
    return (dynLpfMax - dynLpfMin) * curve + dynLpfMin;
}
```

**曲线特性**：
- `expo = 0`：线性
- `expo > 0`：抛物线，中间区域更平缓
- `throttle = 0`：cutoff = dynLpfMin
- `throttle = 1`：cutoff = dynLpfMax

#### 6.2.4 设计理念

**低油门时**：
- 电机转速低
- 振动频率低
- 需要更强滤波 → 低截止频率
- 可以接受更多延迟

**高油门时**：
- 电机转速高
- 振动频率高（可能超过滤波范围）
- 需要快速响应 → 高截止频率
- 延迟必须最小化

#### 6.2.5 典型配置

| 参数 | 典型值 | 说明 |
|-----|-------|------|
| **dterm_lpf1_dyn_min_hz** | 80-100 | 低油门时的截止频率 |
| **dterm_lpf1_dyn_max_hz** | 150-200 | 高油门时的截止频率 |
| **dterm_lpf1_dyn_expo** | 5-7 | 曲线指数 |

#### 6.2.6 代码位置
- 更新函数：`src/main/flight/pid.c` 第1586-1620行
- 曲线计算：`src/main/flight/pid.c` 第1622-1627行

---

### 6.3 RPM滤波器

#### 6.3.1 概述
RPM滤波器基于**实时电机转速**创建动态陷波滤波器，精确消除电机和桨叶产生的振动。

#### 6.3.2 工作原理

```
ESC反馈 → 电机RPM → 计算基频和谐波 → 更新陷波滤波器 → 应用于陀螺仪数据
```

**关键步骤**：

1. **获取RPM**：通过双向DShot从电调获取转速
2. **计算频率**：
   ```
   基频 = RPM / 60 × (桨叶数量 / 2)
   谐波 = 基频 × N (N = 1, 2, 3, ...)
   ```
3. **创建陷波**：为每个电机的每个谐波创建陷波滤波器
4. **应用滤波**：在陀螺仪滤波链早期应用

#### 6.3.3 优势

- **极其精确**：直接跟踪电机转速
- **覆盖全范围**：从悬停到全油门
- **多谐波**：可以消除基频和多个谐波
- **低CPU开销**：陷波滤波器计算量小

#### 6.3.4 要求

- 必须使用支持双向DShot的电调
- 电调固件必须支持RPM反馈
- DShot协议配置正确

#### 6.3.5 代码位置
- 实现：`src/main/flight/rpm_filter.c`
- 应用：`src/main/sensors/gyro_filter_impl.c` 第48-50行

---

## 七、完整信号流程图

### 7.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Betaflight 滤波架构                        │
└─────────────────────────────────────────────────────────────────┘

┌───────────────┐     ┌──────────────┐     ┌─────────────┐
│  遥控器输入    │────→│  RC平滑滤波   │────→│ PID控制器   │
│  Raw RC Data  │     │  PT3 Filter  │     │             │
└───────────────┘     └──────────────┘     │             │
                                            │             │
┌───────────────┐     ┌──────────────┐     │             │
│  陀螺仪原始    │────→│ 陀螺仪滤波链  │────→│             │
│  Gyro Raw     │     │  7级滤波     │     │             │
└───────────────┘     └──────────────┘     │             │
                                            │             │
                      ┌──────────────┐     │             │
                      │  D-term滤波   │←────│             │
                      │  3-4级滤波    │     │             │
                      └──────────────┘     │             │
                                            │             │
                                            └──────┬──────┘
                                                   ↓
                                            ┌─────────────┐
                                            │   混控输出   │
                                            │   Motor Mix │
                                            └─────────────┘
```

---

### 7.2 陀螺仪滤波链详细流程

```
┌──────────────────────────────────────────────────────────────────┐
│                          陀螺仪滤波链                              │
│                    Gyro Filter Chain (7 stages)                  │
└──────────────────────────────────────────────────────────────────┘

    gyro.gyroADC[axis]          ← 原始ADC数据（已校准、已缩放）
           ↓
    ┌─────────────────┐
    │  降采样滤波       │         Step 1: Downsampling
    │  Lowpass2 / Avg │         目的：降低采样率，减少计算
    └─────────────────┘         代码：gyro_filter_impl.c:32-43
           ↓
    ┌─────────────────┐
    │  RPM滤波器       │         Step 2: RPM Filter
    │  Dynamic Notch  │         目的：消除电机/桨叶振动
    └─────────────────┘         代码：gyro_filter_impl.c:48-50
           ↓                           rpm_filter.c
    ┌─────────────────┐
    │  静态陷波1       │         Step 3: Static Notch 1
    │  Notch Filter 1 │         目的：消除固定频率噪声
    └─────────────────┘         代码：gyro_filter_impl.c:56
           ↓
    ┌─────────────────┐
    │  静态陷波2       │         Step 4: Static Notch 2
    │  Notch Filter 2 │         目的：消除另一个固定频率
    └─────────────────┘         代码：gyro_filter_impl.c:57
           ↓
    ┌─────────────────┐
    │  低通滤波器      │         Step 5: Gyro Lowpass (LPF1)
    │  Gyro LPF       │         目的：衰减高频噪声
    └─────────────────┘         类型：PT1/PT2/PT3/Biquad
           ↓                    代码：gyro_filter_impl.c:58
    ┌─────────────────┐
    │  动态陷波        │         Step 6: Dynamic Notch
    │  FFT Analysis   │         目的：自动跟踪振动峰值
    └─────────────────┘         代码：gyro_filter_impl.c:64-78
           ↓                           dyn_notch_filter.c
    ┌─────────────────┐
    │  IMU滤波器       │         Step 7: IMU Lowpass (optional)
    │  PT1 @ 50Hz     │         目的：姿态解算用低频滤波
    └─────────────────┘         代码：gyro.c:513
           ↓
    gyro.gyroADCf[axis]        ← 最终输出：完全滤波的陀螺仪数据
           ↓
    【传递给PID控制器】
```

---

### 7.3 D-term滤波链详细流程

```
┌──────────────────────────────────────────────────────────────────┐
│                          D-term滤波链                             │
│                   D-term Filter Chain (7 steps)                  │
└──────────────────────────────────────────────────────────────────┘

    gyro.gyroADCf[axis]        ← 输入：完全滤波的陀螺仪数据
           ↓
    gyroRateDterm[axis]        
           ↓
    ┌─────────────────┐
    │  D-term陷波      │         Step 1: D-term Notch
    │  Notch Filter   │         目的：消除D-term特定频率噪声
    └─────────────────┘         代码：pid.c:1195
           ↓                           pid_init.c:157-165
    ┌─────────────────┐
    │  D-term LPF1    │         Step 2: D-term Lowpass 1
    │  (支持动态LPF)   │         目的：主要的D-term低通滤波
    └─────────────────┘         支持：PT1/PT2/PT3/Biquad
           ↓                    动态：根据油门调整截止频率
    ┌─────────────────┐         代码：pid.c:1196
    │  D-term LPF2    │               pid_init.c:167-216
    │  Second Lowpass │         Step 3: D-term Lowpass 2
    └─────────────────┘         目的：额外降噪，减少延迟累积
           ↓                    代码：pid.c:1197
    ┌─────────────────┐               pid_init.c:218-251
    │  计算微分        │         Step 4: Calculate Derivative
    │  Delta = -Δgyro │         delta = -(current - previous) × freq
    │  × pidFrequency │         代码：pid.c:1408
    └─────────────────┘
           ↓
    ┌─────────────────┐
    │  应用Kd增益     │         Step 5: Apply Kd Gain
    │  preTpaD = Kd×Δ │         preTpaD = Kd × delta
    └─────────────────┘         代码：pid.c:1409
           ↓
    ┌─────────────────┐
    │  D-Max增益      │         Step 6: D-Max (Optional)
    │  (可选功能)      │         目的：快速机动时增强D-term
    └─────────────────┘         检测：涡旋和快速变化
           ↓                    滤波：PT2平滑增益
    ┌─────────────────┐         代码：pid.c:1417-1438
    │  TPA油门衰减    │         Step 7: TPA (Throttle Attenuation)
    │  D × tpaFactor  │         目的：高油门时降低D-term
    └─────────────────┘         代码：pid.c:1441
           ↓
    pidData[axis].D            ← 最终输出：D-term
```

---

### 7.4 RC平滑滤波流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        RC平滑滤波流程                              │
│                     RC Smoothing Filter Chain                    │
└──────────────────────────────────────────────────────────────────┘

    接收机原始数据
    Raw RC Packet
           ↓
    ┌─────────────────┐
    │  检测Rx频率     │         自动检测接收机刷新率
    │  Detect Rate    │         currentRxRateHz
    └─────────────────┘         代码：rc.c:561-616
           ↓
    ┌─────────────────┐
    │  平滑Rx频率     │         使用PT1平滑防止抖动
    │  Smooth Rate    │         smoothedRxRateHz
    └─────────────────┘
           ↓
    ┌─────────────────┐
    │  计算截止频率    │         Auto: fc = rxRate × factor
    │  Calculate fc   │         Manual: fc = user setting
    └─────────────────┘         代码：rc.c:343-380
           ↓
    ┌─────────────────┐
    │  更新PT3滤波器  │         更新滤波器系数
    │  Update Filters │         针对setpoint/feedforward/throttle
    └─────────────────┘
           ↓
    ┌─────────────────┐
    │  应用PT3滤波    │         对每个通道应用滤波
    │  Apply PT3      │         Roll/Pitch/Yaw/Throttle
    └─────────────────┘         代码：rc.c:413-424
           ↓
    平滑的设定点
    Smoothed Setpoint
           ↓
    【传递给PID控制器】
```

---

### 7.5 动态陷波滤波器状态机

```
┌──────────────────────────────────────────────────────────────────┐
│                      动态陷波滤波器状态机                           │
│              Dynamic Notch Filter State Machine                  │
└──────────────────────────────────────────────────────────────────┘

每个PID循环执行一次 dynNotchUpdate()
    ↓
┌──────────────────────────────────────────────┐
│  累积和降采样陀螺仪数据                        │
│  Accumulate & Downsample Gyro Data          │
│  sampleAccumulator[axis] += gyroData        │
└──────────────────────────────────────────────┘
    ↓
┌──────────────────────────────────────────────┐
│  更新SDFT（滑动DFT）                          │
│  Update SDFT                                │
│  sdftPushBatch(&sdft[axis], sampleAvg)      │
└──────────────────────────────────────────────┘
    ↓
    样本累积完成？
    ↓ Yes
┌──────────────────────────────────────────────┐
│  启动状态机处理                               │
│  state.tick = DYN_NOTCH_CALC_TICKS (12)     │
└──────────────────────────────────────────────┘
    ↓
    ┌─────────────────────────────────────────┐
    │  循环：处理每个轴的每个步骤              │
    │  Loop through 3 axes × 4 steps          │
    └─────────────────────────────────────────┘
          ↓
    ┌──────────────┐    ┌──────────────┐
    │  STEP_WINDOW │ →  │ 应用窗口函数  │
    │              │    │ (可选)       │
    └──────────────┘    └──────────────┘
          ↓
    ┌──────────────┐    ┌──────────────┐
    │DETECT_PEAKS  │ →  │ 检测频谱峰值  │
    │              │    │ 找到N个最强峰 │
    └──────────────┘    └──────────────┘
          ↓
    ┌──────────────┐    ┌──────────────┐
    │CALC_FREQS    │ →  │ 计算精确频率  │
    │              │    │ 抛物线插值    │
    └──────────────┘    └──────────────┘
          ↓
    ┌──────────────┐    ┌──────────────┐
    │UPDATE_FILTERS│ →  │ 更新陷波滤波器│
    │              │    │ Biquad系数   │
    └──────────────┘    └──────────────┘
          ↓
    state.axis = (state.axis + 1) % 3
    state.step = (state.step + 1) % 4
          ↓
    继续下一个轴/步骤

总计：3轴 × 4步骤 = 12个PID循环完成一次完整更新
在8kHz PID频率下，每轴更新率 ≈ 666Hz
```

---

### 7.6 时序图：一个PID循环周期

```
时间线（8kHz PID频率，周期125μs）
─────────────────────────────────────────────────────────────→
0μs                                                      125μs

├─ 陀螺仪采样 (5μs)
│  └─ 读取传感器原始数据
│
├─ 陀螺仪滤波 (15-20μs)
│  ├─ 降采样
│  ├─ RPM滤波器 (3μs)
│  ├─ 静态陷波 × 2 (4μs)
│  ├─ 低通滤波器 (3μs)
│  └─ 动态陷波 (5-10μs)
│
├─ 动态陷波更新 (5-15μs，每12个循环执行一次)
│  └─ SDFT + 峰值检测 + 滤波器更新
│
├─ RC处理 (3-5μs)
│  └─ RC平滑滤波
│
├─ PID计算 (30-40μs)
│  ├─ D-term滤波 (8μs)
│  ├─ 计算P/I/D/F (15μs)
│  └─ 其他功能（D-Max等）
│
├─ 混控 (5-10μs)
│  └─ 计算电机输出
│
├─ 电机输出 (5μs)
│  └─ DShot协议
│
└─ 剩余时间：其他任务、调试、通信等

总CPU使用：约60-90μs / 125μs = 48-72%
```

---

## 八、关键代码文件索引

### 8.1 陀螺仪滤波相关

#### 8.1.1 `src/main/sensors/gyro_filter_impl.c`
**功能**：陀螺仪滤波链主实现

**关键函数**：
- `GYRO_FILTER_FUNCTION_NAME()` (第23-87行)
  - 完整的陀螺仪滤波管道
  - 7级滤波处理

**滤波顺序**：
1. 降采样 (第32-43行)
2. RPM滤波器 (第48-50行)
3. 静态陷波1 (第56行)
4. 静态陷波2 (第57行)
5. 陀螺仪低通 (第58行)
6. 动态陷波 (第64-78行)
7. 最终输出 (第84行)

---

#### 8.1.2 `src/main/sensors/gyro.c`
**功能**：陀螺仪数据处理和管理

**关键函数**：
- `gyroUpdate()` (第408-445行)
  - 读取和累积陀螺仪样本
  - 降采样处理
  
- `gyroFiltering()` (第463-520行)
  - 调用滤波链
  - 管理动态陷波更新
  - IMU滤波器

**关键数据结构**：
- `gyro_t` - 陀螺仪全局结构体
  - `gyro.gyroADC[]` - 原始数据
  - `gyro.gyroADCf[]` - 滤波后数据

---

#### 8.1.3 `src/main/sensors/gyro_init.c`
**功能**：陀螺仪滤波器初始化

**关键函数**：
- `gyroInitFilters()` (第195-269行)
  - 初始化所有陀螺仪滤波器
  - 配置滤波器类型和参数

---

### 8.2 PID和D-term滤波相关

#### 8.2.1 `src/main/flight/pid.c`
**功能**：PID控制器主实现

**关键函数**：
- `pidController()` (第1140-1655行)
  - 主PID控制循环
  - D-term滤波和计算

**D-term滤波** (第1183-1198行)：
```c
// 应用D-term滤波链
gyroRateDterm[axis] = pidRuntime.dtermNotchApplyFn(...);      // 陷波
gyroRateDterm[axis] = pidRuntime.dtermLowpassApplyFn(...);    // LPF1
gyroRateDterm[axis] = pidRuntime.dtermLowpass2ApplyFn(...);   // LPF2
```

**D-term计算** (第1408-1409行)：
```c
const float delta = -(gyroRateDterm[axis] - previousGyroRateDterm[axis]) * pidRuntime.pidFrequency;
float preTpaD = pidRuntime.pidCoefficient[axis].Kd * delta;
```

**D-Max** (第1417-1438行)：
- 动态D-term增益调整

**TPA** (第1441行)：
- 油门衰减应用

**动态LPF更新** (第1586-1620行)：
- `dynLpfDTermUpdate()` - 根据油门更新D-term LPF1截止频率

---

#### 8.2.2 `src/main/flight/pid_init.c`
**功能**：PID滤波器初始化和配置

**关键函数**：
- `pidInitFilters()` (第131-596行)
  - 初始化所有PID相关滤波器

**滤波器初始化**：
- D-term陷波 (第146-165行)
- D-term LPF1 (第167-216行)
  - 支持PT1/PT2/PT3/Biquad
  - 支持动态LPF配置
- D-term LPF2 (第218-251行)
- P-term Yaw LPF (第252-271行)

---

### 8.3 动态陷波滤波器

#### 8.3.1 `src/main/flight/dyn_notch_filter.c`
**功能**：动态陷波滤波器实现（FFT分析）

**关键函数**：
- `dynNotchInit()` (第156-210行)
  - 初始化动态陷波系统
  - 配置SDFT参数
  
- `dynNotchUpdate()` (第215-250行)
  - 每个PID循环调用
  - 累积数据和更新SDFT
  - 触发状态机处理
  
- `dynNotchProcess()` (第253-404行)
  - 状态机实现
  - 4个步骤：窗口、检测峰值、计算频率、更新滤波器
  
- `dynNotchFilter()` (第406-413行)
  - 应用陷波滤波
  - 串联所有陷波滤波器

**状态机步骤**：
1. `STEP_WINDOW` - 应用窗口函数
2. `STEP_DETECT_PEAKS` - 检测频谱峰值 (第290-336行)
3. `STEP_CALC_FREQUENCIES` - 计算精确频率 (第337-387行)
4. `STEP_UPDATE_FILTERS` - 更新Biquad系数 (第388-400行)

**关键算法**：
- SDFT频谱分析
- 峰值检测
- 抛物线插值（亚bin精度）
- PT1平滑跟踪

---

#### 8.3.2 `src/main/flight/dyn_notch_filter.h`
**功能**：动态陷波接口和配置

**关键宏**：
- `DYN_NOTCH_COUNT_MAX` - 最大陷波数量
- `SDFT_BIN_COUNT` - FFT bin数量（通常72）

---

### 8.4 RPM滤波器

#### 8.4.1 `src/main/flight/rpm_filter.c`
**功能**：基于电机转速的动态陷波滤波器

**关键函数**：
- `rpmFilterInit()` - 初始化RPM滤波器
- `rpmFilterUpdate()` - 更新电机转速和陷波频率
- `rpmFilterApply()` - 应用RPM陷波滤波

**工作原理**：
- 从双向DShot获取电机RPM
- 计算基频和谐波
- 为每个电机/谐波创建陷波滤波器
- 在陀螺仪滤波链早期应用

---

### 8.5 RC平滑滤波

#### 8.5.1 `src/main/fc/rc.c`
**功能**：遥控器信号处理和平滑

**关键函数**：
- `processRcCommand()` (第618-898行)
  - 主RC处理函数
  - 检测Rx频率
  - 更新滤波器截止频率
  
- `processRcSmoothingFilter()` (第395-425行)
  - 应用PT3滤波到设定点
  - 应用PT3滤波到前馈
  
- `rcSmoothingSetFilterCutoffs()` (第343-380行)
  - 计算和更新滤波器截止频率
  - 支持自动和手动模式
  
- `shouldUpdateSmoothing()` (第561-616行)
  - 检测Rx频率变化
  - 平滑Rx频率估计
  - 决定何时更新滤波器

**Feedforward滤波** (第383-392行)：
- `updateFeedforwardFilters()` - 更新FF平滑滤波器

---

### 8.6 滤波器算法实现

#### 8.6.1 `src/main/common/filter.c`
**功能**：各种滤波器算法的底层实现

**PT1滤波器** (第61-80行)：
- `pt1FilterGain()` - 计算增益
- `pt1FilterInit()` - 初始化
- `pt1FilterApply()` - 应用滤波

**PT2滤波器** (第82-119行)：
- `pt2FilterGain()` - 计算增益
- `pt2FilterInit()` - 初始化
- `pt2FilterApply()` - 应用滤波

**PT3滤波器** (第121-159行)：
- `pt3FilterGain()` - 计算增益
- `pt3FilterInit()` - 初始化
- `pt3FilterApply()` - 应用滤波

**Biquad滤波器** (第164-353行)：
- `biquadFilterInit()` - 初始化任意Biquad
- `biquadFilterInitLPF()` - 初始化低通
- `biquadFilterUpdate()` - 更新系数
- `biquadFilterApply()` - 应用滤波（DF2）
- `biquadFilterApplyDF1()` - 应用滤波（DF1）
- `filterGetNotchQ()` - 计算陷波Q值

---

#### 8.6.2 `src/main/common/filter.h`
**功能**：滤波器数据结构和接口定义

**关键数据结构**：
- `pt1Filter_t` - PT1滤波器状态
- `pt2Filter_t` - PT2滤波器状态
- `pt3Filter_t` - PT3滤波器状态
- `biquadFilter_t` - Biquad滤波器状态
- `filter_t` - 通用滤波器联合体

**滤波器类型枚举**：
```c
typedef enum {
    FILTER_PT1,
    FILTER_BIQUAD,
    FILTER_PT2,
    FILTER_PT3,
} filterType_e;

typedef enum {
    FILTER_LPF,
    FILTER_NOTCH,
    FILTER_BPF,
} biquadFilterType_e;
```

---

### 8.7 配置和参数

#### 8.7.1 `src/main/pg/`目录
**功能**：参数组（Parameter Group）配置

**相关文件**：
- `gyro.c` / `gyro.h` - 陀螺仪配置
- `pid.c` / `pid.h` - PID配置
- `rc_controls.c` / `rc_controls.h` - RC配置

---

### 8.8 代码导航地图

```
滤波系统代码结构
├── 陀螺仪滤波
│   ├── gyro_filter_impl.c ← 滤波链实现
│   ├── gyro.c ← 数据处理
│   └── gyro_init.c ← 初始化
│
├── PID和D-term
│   ├── pid.c ← 主控制循环
│   └── pid_init.c ← 滤波器初始化
│
├── 动态滤波
│   ├── dyn_notch_filter.c ← 动态陷波（FFT）
│   └── rpm_filter.c ← RPM滤波器
│
├── RC处理
│   └── rc.c ← RC平滑和Feedforward
│
└── 滤波器库
    ├── filter.c ← 算法实现
    └── filter.h ← 数据结构和接口
```

---

### 8.9 调试和诊断

#### Debug模式
Betaflight支持多种调试模式来观察滤波效果：

**陀螺仪调试**：
- `DEBUG_GYRO_RAW` - 原始ADC值
- `DEBUG_GYRO_SCALED` - 缩放后的陀螺仪数据
- `DEBUG_GYRO_FILTERED` - 最终滤波输出
- `DEBUG_GYRO_SAMPLE` - 各滤波阶段的样本

**D-term调试**：
- `DEBUG_D_LPF` - D-term滤波前后对比
- `DEBUG_D_MAX` - D-Max增益调整

**动态陷波调试**：
- `DEBUG_FFT` - FFT频谱数据
- `DEBUG_FFT_FREQ` - 检测到的峰值频率
- `DEBUG_DYN_LPF` - 动态LPF状态

**RC调试**：
- `DEBUG_RC_SMOOTHING` - RC平滑状态
- `DEBUG_RC_INTERPOLATION` - RC插值

**使用方法**：
```c
// 在代码中设置调试值
DEBUG_SET(DEBUG_GYRO_FILTERED, axis, lrintf(gyroADCf));

// 在Betaflight Configurator中：
// 1. 选择Debug模式
// 2. 在黑盒日志中查看
// 3. 使用PID Toolbox分析
```

---

## 附录A：滤波器性能对比

### A.1 延迟对比（在100Hz截止频率）

| 滤波器 | 群延迟 @ fc | 相位滞后 @ fc | 滚降斜率 |
|--------|------------|--------------|----------|
| PT1    | 1.6ms      | -45°         | -20dB/dec |
| PT2    | 3.2ms      | -90°         | -40dB/dec |
| PT3    | 4.8ms      | -135°        | -60dB/dec |
| Biquad | 3.2ms      | -90°         | -40dB/dec |

### A.2 CPU使用估算（F7处理器，8kHz PID）

| 滤波操作 | CPU周期 | 百分比 |
|---------|--------|--------|
| 陀螺仪滤波链 | 1500-2000 | 15-20% |
| D-term滤波 | 600-800 | 6-8% |
| 动态陷波更新 | 500-1500 | 5-15% (均摊) |
| RC平滑 | 200-400 | 2-4% |
| **总计** | **2800-4700** | **28-47%** |

---

## 附录B：推荐配置

### B.1 标准5寸穿越机配置

```
陀螺仪滤波：
- Gyro LPF1: PT1 @ 150Hz
- Dynamic Notch: 启用，3个陷波，Q=300
- RPM Filter: 启用（如果支持）

D-term滤波：
- D-term LPF1: PT1 @ 100Hz（动态80-150Hz）
- D-term LPF2: PT1 @ 150Hz
- D-term Notch: 禁用或120Hz

RC平滑：
- 自动模式，Setpoint自动因子=30
```

### B.2 清洁飞行（低噪声）配置

```
陀螺仪滤波：
- Gyro LPF1: PT1 @ 200Hz
- Dynamic Notch: 启用，2个陷波
- 静态陷波: 禁用

D-term滤波：
- D-term LPF1: PT1 @ 120Hz（动态100-180Hz）
- D-term LPF2: 禁用
- D-term Notch: 禁用
```

### B.3 暴力飞行（强滤波）配置

```
陀螺仪滤波：
- Gyro LPF1: PT2 @ 120Hz
- Dynamic Notch: 启用，5个陷波，Q=400
- 静态陷波: 根据需要配置

D-term滤波：
- D-term LPF1: PT1 @ 80Hz（动态60-120Hz）
- D-term LPF2: PT1 @ 120Hz
- D-term Notch: 80-100Hz
```

---

## 附录C：故障排查指南

### C.1 电机过热
**可能原因**：滤波不足，噪声进入PID
**解决方案**：
- 降低陀螺仪LPF1截止频率
- 启用或增加动态陷波数量
- 降低D-term LPF1截止频率

### C.2 响应迟钝
**可能原因**：滤波过强，延迟过大
**解决方案**：
- 提高滤波器截止频率
- 使用PT1代替PT2/PT3
- 启用动态LPF

### C.3 振荡
**可能原因**：滤波不足或PID太高
**解决方案**：
- 检查动态陷波是否启用
- 降低P和D增益
- 添加静态陷波到已知共振频率

### C.4 Yaw轴抖动
**可能原因**：Yaw轴P-term噪声
**解决方案**：
- 启用P-term Yaw LPF
- 降低Yaw P增益
- 检查电机/框架对齐

---

## 总结

Betaflight的滤波系统是一个高度优化的多级滤波架构，通过以下特点实现了卓越的飞行性能：

1. **分层设计**：陀螺仪滤波 → D-term滤波 → RC滤波，每层都有明确目的
2. **自适应技术**：动态陷波、动态LPF、RPM滤波器自动适应飞行状态
3. **灵活配置**：支持多种滤波器类型和参数，适应不同需求
4. **实时性能**：所有滤波在PID循环内完成，保持<125μs的循环时间
5. **智能权衡**：在噪声抑制和延迟之间取得最佳平衡

理解这个滤波系统是调整和优化Betaflight性能的关键。

---

**文档版本**：1.0  
**更新日期**：2024年10月  
**基于代码版本**：Betaflight 4.5+


