# RC 输入平滑滤波器说明文档

## 概述

为了解决 RC 遥控器死区导致的姿态角度突变问题，在 `command.c` 中实现了一个低通滤波器，用于平滑 RC 输入的姿态角度值（roll, pitch, yaw）。

## 问题描述

### 原始问题
- RC 遥控器的死区会导致 `setpoint->attitude.roll/pitch/yaw` 值突变
- 进入死区：值突变为 0
- 离开死区：值突变到较大值
- 这些突变会传递到外环控制器（角度环），导致内环产生噪声

### 解决方案
使用一阶低通滤波器平滑 RC 输入，减少死区切换时的突变影响。

## 滤波器实现

### 滤波公式
```c
filtered_value = α * new_value + (1 - α) * old_value
```

其中：
- `α` (alpha): 滤波系数，范围 0.01 - 1.00
  - 较大的值 (0.3-0.5) = 更快响应，但平滑效果弱
  - 较小的值 (0.1-0.2) = 更平滑，但响应略慢
  - 默认值: 0.20

### 关键特性
1. **自动初始化**：第一次运行时直接使用当前值初始化
2. **解锁状态管理**：解除武装时自动重置滤波器，避免下次起飞时受旧值影响
3. **可配置**：通过 Kconfig 可以启用/禁用和调整滤波系数

## Kconfig 配置

### 启用滤波器
```
menuconfig PROJECT_MINIFLY_TASK_STABLIZE_RC_FILTER_EN
    bool "ENABLE: RC Input Smoothing Filter"
    default y
```

### 调整滤波系数
```
config PROJECT_MINIFLY_TASK_STABLIZE_RC_FILTER_ALPHA
    int "RC Filter Alpha (x100)"
    range 1 100
    default 20
```

**注意**：配置值是实际系数的 100 倍（整数存储）
- 配置值 20 = 实际系数 0.20
- 配置值 10 = 实际系数 0.10
- 配置值 30 = 实际系数 0.30

## 使用建议

### 推荐参数
- **平滑优先**（死区问题严重）：alpha = 0.10 - 0.15
- **平衡模式**（默认）：alpha = 0.20
- **响应优先**（对延迟敏感）：alpha = 0.25 - 0.30

### 调试建议
1. 启用 mlog RC 数据记录（`PROJECT_MINIFLY_TASK_STABLIZE_MLOG_RC_EN`）
2. 记录飞行数据，观察 RC 输入的平滑效果
3. 根据实际效果调整 alpha 值

## 代码修改清单

### 1. aMlogStabilze.c
- 为所有 mlog 数据结构添加 `__packed` 属性
- 解决结构体内存对齐问题（sizeof 计算准确）

### 2. command.c
- 添加 RC 输入低通滤波器实现
- 支持 Kconfig 配置启用/禁用
- 自动处理解锁状态变化

### 3. Kconfig
- 添加 RC 滤波器配置选项
- 可调节滤波系数（1-100，对应 0.01-1.00）

## 性能影响

- **CPU 开销**：极小（仅 3 次浮点乘加运算）
- **内存开销**：20 字节静态变量
- **延迟影响**：约 1-3 个控制周期（取决于 alpha 值）

## 禁用滤波器

如果需要恢复原始行为（不使用滤波器），在 Kconfig 中禁用：
```
PROJECT_MINIFLY_TASK_STABLIZE_RC_FILTER_EN = n
```

## 滤波效果示例

假设 alpha = 0.20：
```
RC 输入:     0.0  ->  30.0  (死区突变)
滤波后第1次:  0.0  ->   6.0  (30 * 0.2 + 0 * 0.8)
滤波后第2次:  6.0  ->  10.8  (30 * 0.2 + 6 * 0.8)
滤波后第3次: 10.8  ->  14.6
滤波后第4次: 14.6  ->  17.7
滤波后第5次: 17.7  ->  20.2
...
最终收敛到: 30.0
```

可以看到，突变被平滑成了逐步过渡，大大减少了对控制系统的冲击。

